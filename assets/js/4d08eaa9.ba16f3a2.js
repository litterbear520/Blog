"use strict";(globalThis.webpackChunkmy_blog=globalThis.webpackChunkmy_blog||[]).push([[151],{4155(e,s,n){n.r(s),n.d(s,{assets:()=>l,contentTitle:()=>r,default:()=>m,frontMatter:()=>i,metadata:()=>a,toc:()=>d});const a=JSON.parse('{"id":"LangChain/Memory\u957f\u671f\u4f1a\u8bdd\u8bb0\u5fc6","title":"Memory\u957f\u671f\u4f1a\u8bdd\u8bb0\u5fc6","description":"Memory\u957f\u671f\u4f1a\u8bdd\u8bb0\u5fc6","source":"@site/docs/LangChain/Memory\u957f\u671f\u4f1a\u8bdd\u8bb0\u5fc6.md","sourceDirName":"LangChain","slug":"/LangChain/Memory\u957f\u671f\u4f1a\u8bdd\u8bb0\u5fc6","permalink":"/Blog/docs/LangChain/Memory\u957f\u671f\u4f1a\u8bdd\u8bb0\u5fc6","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/LangChain/Memory\u957f\u671f\u4f1a\u8bdd\u8bb0\u5fc6.md","tags":[],"version":"current","sidebarPosition":20,"frontMatter":{"sidebar_position":20,"description":"Memory\u957f\u671f\u4f1a\u8bdd\u8bb0\u5fc6"},"sidebar":"tutorialSidebar","previous":{"title":"Memory\u4e34\u65f6\u4f1a\u8bdd\u8bb0\u5fc6","permalink":"/Blog/docs/LangChain/Memory\u4e34\u65f6\u4f1a\u8bdd\u8bb0\u5fc6"},"next":{"title":"Nano-Banana","permalink":"/Blog/docs/AIGC/Nano-Banana"}}');var t=n(4848),o=n(8453);const i={sidebar_position:20,description:"Memory\u957f\u671f\u4f1a\u8bdd\u8bb0\u5fc6"},r="Memory\u957f\u671f\u4f1a\u8bdd\u8bb0\u5fc6",l={},d=[{value:"\u5b9e\u73b0\u601d\u8def",id:"\u5b9e\u73b0\u601d\u8def",level:2},{value:"\u4ee3\u7801\u5b9e\u8df5",id:"\u4ee3\u7801\u5b9e\u8df5",level:2}];function c(e){const s={code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.header,{children:(0,t.jsx)(s.h1,{id:"memory\u957f\u671f\u4f1a\u8bdd\u8bb0\u5fc6",children:"Memory\u957f\u671f\u4f1a\u8bdd\u8bb0\u5fc6"})}),"\n",(0,t.jsx)(s.h2,{id:"\u5b9e\u73b0\u601d\u8def",children:"\u5b9e\u73b0\u601d\u8def"}),"\n",(0,t.jsxs)(s.p,{children:["\u4f7f\u7528",(0,t.jsx)(s.code,{children:"InMemoryChatMessageHistory"}),"\u4ec5\u53ef\u4ee5\u5728\u5185\u5b58\u4e2d\u4e34\u65f6\u5b58\u50a8\u4f1a\u8bdd\u8bb0\u5fc6\uff0c\u4e00\u65e6\u7a0b\u5e8f\u9000\u51fa\uff0c\u5219\u8bb0\u5fc6\u4e22\u5931\u3002\n",(0,t.jsx)(s.code,{children:"InMemoryChatMessageHistory"}),"\u7c7b\u7ee7\u627f\u81ea",(0,t.jsx)(s.code,{children:"BaseChatMessageHistory"})]}),"\n",(0,t.jsx)(s.p,{children:"\u5728\u5b98\u65b9\u6ce8\u91ca\u4e2d\u7ed9\u51fa\u4e86\u76f8\u5173\u5b9e\u73b0\u7684\u6307\u5357\uff0c\u5e76\u7ed9\u51fa\u4e86\u57fa\u4e8e\u6587\u4ef6\u7684\u5386\u53f2\u6d88\u606f\u5b58\u50a8\u793a\u4f8b\u4ee3\u7801\u3002"}),"\n",(0,t.jsx)(s.p,{children:"\u6211\u4eec\u53ef\u4ee5\u81ea\u884c\u5b9e\u73b0\u4e00\u4e2a\u57fa\u4e8eJson\u683c\u5f0f\u548c\u672c\u5730\u6587\u4ef6\u7684\u4f1a\u8bdd\u6570\u636e\u4fdd\u5b58\u3002"}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.code,{children:"FileChatMessageHistory"}),"\u7c7b\u5b9e\u73b0\uff0c\u6838\u5fc3\u601d\u8def\uff1a"]}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["\u57fa\u4e8e\u6587\u4ef6\u5b58\u50a8\u4f1a\u8bdd\u8bb0\u5f55\uff0c\u4ee5",(0,t.jsx)(s.code,{children:"session_id"}),"\u4e3a\u6587\u4ef6\u540d\uff0c\u4e0d\u540c",(0,t.jsx)(s.code,{children:"session_id"}),"\u6709\u4e0d\u540c\u6587\u4ef6\u5b58\u50a8\u6d88\u606f"]}),"\n"]}),"\n",(0,t.jsxs)(s.p,{children:["\u7ee7\u627f",(0,t.jsx)(s.code,{children:"BaseChatMessageHistory"}),"\u5b9e\u73b0\u5982\u4e0b3\u4e2a\u65b9\u6cd5\uff1a"]}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"add_messages"}),"\uff1a\u540c\u6b65\u6a21\u5f0f\uff0c\u6dfb\u52a0\u6d88\u606f"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"messages"}),"\uff1a\u540c\u6b65\u6a21\u5f0f\uff0c\u83b7\u53d6\u6d88\u606f"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"clear"}),"\uff1a\u540c\u6b65\u6a21\u5f0f\uff0c\u6e05\u9664\u6d88\u606f"]}),"\n"]}),"\n",(0,t.jsxs)(s.p,{children:["\u5982\u4e0b\u4ee3\u7801\uff0c\u5b98\u65b9\u5728",(0,t.jsx)(s.code,{children:"BaseChatMessageHistory"}),"\u7c7b\u7684\u6ce8\u91ca\u4e2d\u63d0\u4f9b\u4e86\u4e00\u4e2a\u57fa\u4e8e\u6587\u4ef6\u5b58\u50a8\u7684\u793a\u4f8b\u4ee3\u7801\u3002"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-python",children:'import json\nimport os\nfrom typing import Sequence\nfrom langchain_core.chat_history import BaseChatMessageHistory\nfrom langchain_core.messages import BaseMessage, messages_from_dict, message_to_dict\n\n\nclass FileChatMessageHistory(BaseChatMessageHistory):\n    storage_path: str\n    session_id: str\n\n    def __init__(self, storage_path: str, session_id: str):\n        self.storage_path = storage_path\n        self.session_id = session_id\n\n    @property\n    def messages(self) -> list[BaseMessage]:\n        try:\n            with open(\n                os.path.join(self.storage_path, self.session_id),\n                "r",\n                encoding="utf-8",\n            ) as f:\n                messages_data = json.load(f)\n                return messages_from_dict(messages_data)\n        except FileNotFoundError:\n            return []\n\n    def add_messages(self, messages: Sequence[BaseMessage]) -> None:\n        all_messages = list(self.messages)  # Existing messages\n        all_messages.extend(messages)  # Add new messages\n\n        serialized = [message_to_dict(message) for message in all_messages]\n        file_path = os.path.join(self.storage_path, self.session_id)\n        os.makedirs(os.path.dirname(file_path), exist_ok=True)\n        with open(file_path, "w", encoding="utf-8") as f:\n            json.dump(serialized, f)\n\n    def clear(self) -> None:\n        file_path = os.path.join(self.storage_path, self.session_id)\n        os.makedirs(os.path.dirname(file_path), exist_ok=True)\n        with open(file_path, "w", encoding="utf-8") as f:\n            json.dump([], f)\n'})}),"\n",(0,t.jsx)(s.h2,{id:"\u4ee3\u7801\u5b9e\u8df5",children:"\u4ee3\u7801\u5b9e\u8df5"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-python",children:'import os\nimport json\n\nfrom typing import Sequence\nfrom langchain_community.chat_models.tongyi import ChatTongyi\nfrom langchain_core.runnables.history import RunnableWithMessageHistory\nfrom langchain_core.prompts import MessagesPlaceholder, ChatPromptTemplate\nfrom langchain_core.output_parsers import StrOutputParser\nfrom langchain_core.messages import message_to_dict, messages_from_dict,BaseMessage\nfrom langchain_core.chat_history import BaseChatMessageHistory\n# message_to_dict: \u5355\u4e2a\u6d88\u606f\u5bf9\u8c61 (BaseMessage\u7c7b\u5b9e\u4f8b) -> \u5b57\u5178\n# messages_from_dict: [\u5b57\u5178, \u5b57\u5178...] -> [\u6d88\u606f, \u6d88\u606f...]\n# AIMessage\u3001HumanMessage\u3001SystemMessage \u90fd\u662fBaseMessage\u7684\u5b50\u7c7b\nfrom dotenv import load_dotenv\n\nload_dotenv()\nLLM_API_KEY = os.getenv("LLM_API_KEY")\n\n\nclass FileChatMessageHistory(BaseChatMessageHistory):\n    def __init__(self, session_id, storage_path):\n        self.session_id = session_id              # \u4f1a\u8bddid\n        self.storage_path = storage_path          # \u4e0d\u540c\u4f1a\u8bddid\u7684\u5b58\u50a8\u6587\u4ef6\uff0c\u6240\u5728\u7684\u6587\u4ef6\u5939\u8def\u5f84\n        # \u5b8c\u6574\u7684\u6587\u4ef6\u8def\u5f84\n        self.file_path = os.path.join(self.storage_path, self.session_id)\n\n        # \u786e\u4fdd\u6587\u4ef6\u5939\u662f\u5b58\u5728\u7684\n        os.makedirs(os.path.dirname(self.file_path), exist_ok=True)\n\n    def add_messages(self, messages: Sequence[BaseMessage]) -> None:\n        # Sequence\u5e8f\u5217 \u7c7b\u4f3clist\u3001tuple\n        all_messages = list(self.messages)        # \u5df2\u6709\u7684\u6d88\u606f\u5217\u8868\n        all_messages.extend(messages)             # \u65b0\u7684\u548c\u5df2\u6709\u7684\u878d\u5408\u6210\u4e00\u4e2alist\n\n        # \u5c06\u6570\u636e\u540c\u6b65\u5199\u5165\u5230\u672c\u5730\u6587\u4ef6\u4e2d\n        # \u7c7b\u5bf9\u8c61\u5199\u5165\u6587\u4ef6 -> \u4e00\u5806\u4e8c\u8fdb\u5236\n        # \u4e3a\u4e86\u65b9\u4fbf\uff0c\u53ef\u4ee5\u5c06BaseMessage\u6d88\u606f\u8f6c\u4e3a\u5b57\u5178\uff08\u501f\u52a9json\u6a21\u5757\u4ee5json\u5b57\u7b26\u4e32\u5199\u5165\u6587\u4ef6\uff09\n        # \u5b98\u65b9message_to_dict\uff1a\u5355\u4e2a\u6d88\u606f\u5bf9\u8c61\uff08BaseMessage\u7c7b\u5b9e\u4f8b\uff09 -> \u5b57\u5178\n        # new_messages = []\n        # for message in all_messages:\n        #     d = message_to_dict(message)\n        #     new_messages.append(d)\n\n        new_messages = [message_to_dict(message) for message in all_messages]\n        # \u5c06\u6570\u636e\u5199\u5165\u6587\u4ef6\n        with open(self.file_path, "w", encoding="utf-8") as f:\n            json.dump(new_messages, f, ensure_ascii=False,indent=4)\n\n    @property\n    # @property\u88c5\u9970\u5668\u5c06messages\u65b9\u6cd5\u53d8\u6210\u6210\u5458\u5c5e\u6027\u7528\n    def messages(self) -> list[BaseMessage]:\n        # \u5f53\u524d\u6587\u4ef6\u5185: list[\u5b57\u5178]\n        try:\n            with open(self.file_path, "r", encoding="utf-8") as f:\n                messages_data = json.load(f)  # \u8fd4\u56de\u503c\u5c31\u662f: list[\u5b57\u5178]\n                return messages_from_dict(messages_data)\n        except FileNotFoundError:\n            return []\n\n    def clear(self) -> None:\n        with open(self.file_path, "w", encoding="utf-8") as f:\n            json.dump([], f)\n\nmodel = ChatTongyi(model="qwen3-max",api_key=LLM_API_KEY)\n# prompt = PromptTemplate.from_template(\n#     "\u4f60\u9700\u8981\u6839\u636e\u4f1a\u8bdd\u5386\u53f2\u56de\u5e94\u7528\u6237\u95ee\u9898\u3002\u5bf9\u8bdd\u5386\u53f2\uff1a{chat_history}\uff0c\u7528\u6237\u63d0\u95ee\uff1a{input}\uff0c\u8bf7\u56de\u7b54"\n# )\nprompt = ChatPromptTemplate.from_messages(\n    [\n        ("system","\u4f60\u9700\u8981\u6839\u636e\u4f1a\u8bdd\u5386\u53f2\u56de\u5e94\u7528\u6237\u95ee\u9898\u3002\u5bf9\u5e94\u5386\u53f2\uff1a"),\n        MessagesPlaceholder("chat_history"),\n        ("human","\u8bf7\u56de\u7b54\u5982\u4e0b\u95ee\u9898\uff1a{input}")\n    ]\n)\nstr_parser = StrOutputParser()\n\ndef print_prompt(full_prompt):\n    print("="*20, full_prompt.to_string(), "="*20)\n    return full_prompt\n\nbase_chain = prompt | print_prompt | model | str_parser\n\nstore = {} # key\u5c31\u662fsession\uff0cvalue\u5c31\u662fInMemoryChatMessageHistory\u7c7b\u5bf9\u8c61\n# \u5b9e\u73b0\u901a\u8fc7\u4f1a\u8bddid\u83b7\u53d6InMemoryChatMessageHistory\u7c7b\u5bf9\u8c61\ndef get_history(session_id):\n    return FileChatMessageHistory(session_id, "./chat_history")\n\n# \u521b\u5efa\u4e00\u4e2a\u65b0\u7684\u94fe\uff0c\u5bf9\u539f\u6709\u94fe\u589e\u5f3a\u529f\u80fd\uff1a\u81ea\u52a8\u9644\u52a0\u5386\u53f2\u6d88\u606f\nconversation_chain = RunnableWithMessageHistory(\n    base_chain,                          # \u88ab\u589e\u5f3a\u7684\u539f\u6709chain\n    get_history,                         # \u901a\u8fc7\u4f1a\u8bddid\u83b7\u53d6InMemoryChatMessageHistory\u7c7b\u5bf9\u8c61\n    input_messages_key="input",          # \u8868\u793a\u7528\u6237\u8f93\u5165\u5728\u6a21\u677f\u4e2d\u7684\u5360\u4f4d\u7b26\n    history_messages_key="chat_history"  # \u8868\u793a\u5386\u53f2\u6d88\u606f\u5728\u6a21\u677f\u4e2d\u7684\u5360\u4f4d\u7b26\n)\n\nif __name__ == \'__main__\':\n    # \u56fa\u5b9a\u683c\u5f0f\uff0c\u6dfb\u52a0LangChain\u7684\u914d\u7f6e\uff0c\u4e3a\u5f53\u524d\u7a0b\u5e8f\u914d\u7f6e\u6240\u5c5e\u7684session_id\n    session_config = {\n        "configurable": {\n            "session_id": "user_001"\n        }\n    }\n\n    res = conversation_chain.invoke(input={"input": "\u5c0f\u660e\u67092\u4e2a\u732b"}, config=session_config)\n    print("\u7b2c1\u6b21\u6267\u884c\uff1a", res)\n\n    res = conversation_chain.invoke(input={"input": "\u5c0f\u521a\u67091\u53ea\u72d7"}, config=session_config)\n    print("\u7b2c2\u6b21\u6267\u884c\uff1a", res)\n\n    # res = conversation_chain.invoke(input={"input": "\u603b\u5171\u6709\u51e0\u4e2a\u5ba0\u7269"}, config=session_config)\n    # print("\u7b2c3\u6b21\u6267\u884c\uff1a", res)\n'})})]})}function m(e={}){const{wrapper:s}={...(0,o.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},8453(e,s,n){n.d(s,{R:()=>i,x:()=>r});var a=n(6540);const t={},o=a.createContext(t);function i(e){const s=a.useContext(o);return a.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function r(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),a.createElement(o.Provider,{value:s},e.children)}}}]);